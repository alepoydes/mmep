MAKEFLAGS += --no-builtin-rules
.SUFFIXES:

LIB:=-lm
LIBGL:=-lglut -lGLU -lGL -pthread -lpng

OBJDIR:=obj
BINDIR:=bin
SRCDIR:=src
vpath %.c  $(SRCDIR)
vpath %.h  $(SRCDIR)
SRC:=parse.c vector.c skyrmion.c plot.c optim.c debug.c octave.c integra.c
SRCGL:=display.c bitmap.c

all:

define binary
BIN+=$(1)f $(1)d $(1)q

$(BINDIR)/$(1)f: $(addprefix $(OBJDIR)/,$(2:.c=.f.o)) $(OBJDIR)/$(1).f.o
	$(CC) $$^ $$(OPT) $(3) -o $$@

$(BINDIR)/$(1)d: $(addprefix $(OBJDIR)/,$(2:.c=.d.o)) $(OBJDIR)/$(1).d.o
	$(CC) $$^ $$(OPT) $(3) -o $$@

$(BINDIR)/$(1)q: $(addprefix $(OBJDIR)/,$(2:.c=.q.o)) $(OBJDIR)/$(1).q.o
	$(CC) $$^ $$(OPT) $(3) -o $$@
endef

%.html: %.md
	pandoc $^ -t html -f markdown -s -o $@

$(OBJDIR)/%.f.o: %.c $(SRCDIR)/*.h
	$(CC) $< $(OPT) -I $(SRCDIR) -c -o $@	

$(OBJDIR)/%.d.o: %.c $(SRCDIR)/*.h
	$(CC) $< $(OPT) -I $(SRCDIR) -c -DDOUBLE -o $@	

$(OBJDIR)/%.q.o: %.c $(SRCDIR)/*.h
	$(CC) $< $(OPT) -I $(SRCDIR) -c -DQUAD -o $@	

$(eval $(call binary,mc,$(SRC),$(LIB)))
$(eval $(call binary,min,$(SRC),$(LIB)))
$(eval $(call binary,min2,$(SRC),$(LIB)))
$(eval $(call binary,mep,$(SRC),$(LIB)))
$(eval $(call binary,sim,$(SRC) $(SRCGL),$(LIB) $(LIBGL)))
$(eval $(call binary,play,$(SRC) $(SRCGL),$(LIB) $(LIBGL)))

BINEXP=$(addprefix $(BINDIR)/,$(BIN))
all: README.html $(BINEXP)

clean:
	rm -f $(OBJDIR)/*.o $(BINEXP) 
