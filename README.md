# Miser - набор программ для моделирования магнитных скирмионов

Данный программный комплекс содержит набор программ 
для моделирования магнитных скирмионов на решетках общего вида.
Программы настраиваются с помощью конфигурационных файлов,
что позволяет избежать программирования во многих случаях.
Программы автоматически ускоряют вычисления, 
распараллеливания вычисления с общей памятью при возможности.
Результаты вычислений сохраняются в формате GNUPlot,
что дает гибкие возможности для визуализации.
Также комплекс содержит вспомогательные скрипты,
позволяющие автоматизировать рутинные процедуры.

## Установка

### Требования к окружению

С минимальной адаптацией программных комплекс может
быть использован в операционных системах Linux, Mac OS, Windows.
Без адаптации комплекс можно использовать в [Ubuntu](http://www.ubuntu.com/) 
версии 15.10.

Для компилляции используется компиллятор [GCC](https://gcc.gnu.org/).
Текст программ написан на C99 с минимальным использованием расширений
GNU, что позволяет относительно легко адаптировать его под другие
компилляторы.
В Ubuntu GCC может быть уже установлен, если нет, то для установки выполните:

    sudo apt-get install gcc

Для сборки используется [GNU Make](https://www.gnu.org/software/make/),
который должен быть предустановлен в Ubuntu.

Для графического вывода используется [gnulot](http://www.gnuplot.info/).
Выполнение программ возможно без установленного gnuplot,
но для генерации графики и вывода прогресса вычислений gnuplot
должен быть установлен и путь к нему должен быть прописан в PATH.
Для установки gnuplot в Ubuntu воспользуйтесь командой:

    sudo apt-get install gnuplot

Вспомогательные скрипты используют оболочку 
[GNU Bash](https://www.gnu.org/software/bash/)
и [envsubst](https://www.gnu.org/software/gettext/manual/html_node/envsubst-Invocation.html).
В Ubuntu эти программы вероятнее всего предустановленны.

Для подготовки документации используется [pandoc](http://pandoc.org/).
В Ubuntu pandoc можно установить из репозитория:

    sudo apt-get install pandoc

Программы из комплекса используют цветной вывод на терминал,
поэтому для корректного вывода убедитесь, что используемый терминал
поддерживает [ANSI escape code](https://en.wikipedia.org/wiki/ANSI_escape_code)

### Компилляция программ

Собрать программы можно с помощью GNU Make.
Вместе с пакетом поставляется два варианта Makefile'а.

- **Makefile** собирает программы с отладочной информацией и без опитимизации.
- **Makefile.release** собирает программы с оптимизацией, распараллеливанием,
  отключенным выводом отладочной информации и без избыточных проверок.

Для сборки всех программ используйте команду:

    make -f Makefile.release

Для проверки работоспособности выполните команду:

    ./minq rect2.lat

## Использование программного комплекса

Пакет состоит из следующих основных программ:

- **minx** - вычисление устойчивых состояний градиентным спуском (рекомендуется)
- **min2x** - вычисление устойчивых состояний методом Лагранжа-сопряженной невязки (альфа версия)
- **mepx** - вычисление пути с минимальным перепадом энергии

Вместо буквы 'x' в названии используйте одну из следующих литер,
задающих точность арифметики:

- **f** для арифметики одинарной точности (7.2 десятичных знаков)
- **d** для арифметики двойной точности (15.9 десятичных знаков)
- **q** для арифметики расширенной точности (19.2 десятичных знака)

Кроме этого комплекс содержит вспомогательные скрипты:

- **mini.sh** - обертка для **minq**, имеет тот же формат вызова,
но автоматически вызывает gnuplot для вывода прогресса решения.
Аналогично **min2i.sh** и **mepi.sh** являются обертками для **minq**
и **mepq**, включающими графический вывод прогресса решения.
- **batch.sh** - скрипт, многократно вызывающий **mepq** с различными
параметрами, для исследования зависимости пути с минимальным перепадом 
энергии от параметров задачи.

### Использование **minx** и **min2x**

Программы **minx** и **min2x** используются для вычисления устойчивых
состояний скирмионных систем.
Вызов программ осуществляется из командной строки.
Параметры командной строки имеют вид:

    minq  [опции] [файл с описанием системы]

Допустимы следующие опции:

- **-h**, **--help** - выводит информацию о вызове программы
- **-e <число>** - устанавливает желаемое значение невязки
- **-i <число>** - устанавливает максимальное число итераций
- **-m <число>** - выбирает режим выбора шага метода градиентного спуска
- **-a <число>** - первый параметр для численного метода
- **-b <число>** - второй параметр для численного метода
- **-p**, **--plot** - разрешает вывод в стандартный поток вывода команд
  gnuplot, отражающих прогресс решения
- **-r <число>** - сколько итераций нужно выполнить до вывода прогресса решения

Прогресс решения выводится в стандартный поток ошибок (обычно на терминал)
в следующем формате:

    <итерация>: E <энергия состояния><изменение энергии> R <норма градиента> <невязка ограничений> A <параметр решателя>

Вычисления отанавливаются, если невязка становится меньше, чем число, переданное в параметре **-e**, либо достигнутое максимальное число итераций,
установленное параметром **-i**.
Если была достигнута желаемая точность, то программа 
устанавливает exit code в ноль. 
В противном случае exit code равне коду ошибки:

- **1** - превышено число итераций

При успешном завершении программа создает файл *fields/state.gnuplot*,
содержащий команды для отрисовки состояния системы, вместе
с данными о состоянии векторного поля.
Для создания рисунка выполните команду

    gnuplot fields/state.gnuplot

Результатом выполнения будет файл *fields/state.png*.
Файл *fields/state.gnuplot* является обычным текстовым файлом,
его можно редактировать для изменения формата вывода,
см. документацию gnuplot, чтобы узнать, как это делается.

Чтобы увидеть прогресс решения, используйте соответствующий скрипт:

    mini.sh [опции] [файл с описанием системы]

Физические параметры системы, начальное и конечное состояния
подготавливаются в специальном формате и передаются в программу
либо в агрументе [файл с описанием системы], либо через
стандартный поток ввода, если программа вызвается без опциональных аргументов.
Пример файла описания системы, а также описание формата файла,
смотрите в файлах **rect2.lat**, **rect3.lat**.

Решатель поддерживает несколько режимов, 
режим устанавливается опцией **-m**.
Метод градинетного спуска, релазиуемый программой **minx**
поддерживает следующие значения первого параметра,
указывающие, как выбирать шаг в направлении градиента на каждой итерации:

- **0** - постоянный шаг, задаваемый первым параметром.
- **1** - инерционный режим, шаг нараживается пропорционально предыдущему шагу и первому параметру.
- **2** - шаг увеличивается каждый раз в первый параметр плюс один раз (по умолчанию).
- **3** - щаг выбирается вычислением гессиана.

Первый параметр задает величину шага (по умолчанию 0.2).
Большое значения шага может разрушить сходимость,
малое значение шага делает сходимость медленной.
Рекомендуется запусть программу со значнием шага по умолчанию,
затем увеличивать значение при медленной сходимости,
либо уменьшать если невязка перестает уменьшаться.

### Использование **mepx**

Программа **mepx** предназначения для вычисления пути
с наименьшим перепадом энергии.
Синтаксис вызова программы

    mepx [опции] [файл с описанием системы]

Программа поддерживает теже опции, что и **minx**, 
и несколько дополнительных:

- **-n <число>** - максимальное число узлов искомого пути.
- **-P** - заставляет опцию **-p** выводить состояния вдоль пути, 
  вместо графика изменения энергии вдоль пути, выводимого по умолчанию.

Выполнение программы начинается с вычисления начальной
и конечной конфигураций, задаваемых в файле с описанием системы.
Затем программа выполняет итерации минимизации перепада
энергии вдоль пути.
При успешном завершении минимизации, результат сохраняется в файлах:

- *fields/mep.gnuplot* - анимация, показывающая изменение состояний
  вдоль пути, также содержит численные значения координат всех векторов поля.
- *fields/energy.gnuplot* - график изменения энергии и невязки вдоль пути.

Пример использования с выводом прогресса решения:

    mepi.sh rect2.lat

Результат вычислений можно увидеть на рисунках *fields/energy.png* 
и *fields/energy.gif*.

